name: Release Production Deployment

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy'
        required: true
        type: string

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io

jobs:
  # Detect what changed in the release
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      web-changed: ${{ steps.changes.outputs.web }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      release-tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Get previous release tag
        id: prev-tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ steps.tag.outputs.tag }}^ 2>/dev/null || echo "")
          echo "prev-tag=$PREV_TAG" >> $GITHUB_OUTPUT
      
      - name: Detect changed files
        id: changes
        run: |
          if [ -z "${{ steps.prev-tag.outputs.prev-tag }}" ]; then
            echo "web=true" >> $GITHUB_OUTPUT
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            WEB_CHANGED=$(git diff --name-only ${{ steps.prev-tag.outputs.prev-tag }} ${{ steps.tag.outputs.tag }} | grep -E '^apps/web/' || echo "")
            BACKEND_CHANGED=$(git diff --name-only ${{ steps.prev-tag.outputs.prev-tag }} ${{ steps.tag.outputs.tag }} | grep -E '^(server/|database/|requirements.txt|Dockerfile)' || echo "")
            
            if [ -n "$WEB_CHANGED" ]; then
              echo "web=true" >> $GITHUB_OUTPUT
            else
              echo "web=false" >> $GITHUB_OUTPUT
            fi
            
            if [ -n "$BACKEND_CHANGED" ]; then
              echo "backend=true" >> $GITHUB_OUTPUT
            else
              echo "backend=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Display changes
        run: |
          echo "Release Tag: ${{ steps.tag.outputs.tag }}"
          echo "Previous Tag: ${{ steps.prev-tag.outputs.prev-tag }}"
          echo "Web Changed: ${{ steps.changes.outputs.web }}"
          echo "Backend Changed: ${{ steps.changes.outputs.backend }}"

  # Deploy Backend to Production
  deploy-backend-production:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-changed == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production-backend
      url: https://api.ppop.link
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect-changes.outputs.release-tag }}
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get Docker image tag
        id: image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ github.repository }}/backend:${{ needs.detect-changes.outputs.release-tag }}"
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
      
      - name: Pull and tag Docker image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ github.repository }}/backend:main
          docker tag ${{ env.REGISTRY }}/${{ github.repository }}/backend:main ${{ steps.image.outputs.tag }}
          docker push ${{ steps.image.outputs.tag }}
      
      - name: Deploy to Railway (Production)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE: ${{ secrets.RAILWAY_SERVICE_PRODUCTION }}
        run: |
          echo "Deploying backend to Railway production"
          curl -fsSL https://railway.app/install.sh | sh
          railway link $RAILWAY_SERVICE
          railway up --service backend
      
      - name: Health check
        run: |
          sleep 30
          for i in {1..5}; do
            if curl -f https://api.ppop.link/health; then
              echo "Health check passed"
              exit 0
            fi
            echo "Health check attempt $i failed, retrying..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1
      
      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: backend
        with:
          environment: production
          version: ${{ needs.detect-changes.outputs.release-tag }}
      
      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Backend Production Deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Backend Production Deployment*\nStatus: ${{ job.status }}\nRelease: ${{ needs.detect-changes.outputs.release-tag }}\nURL: https://api.ppop.link\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }

  # Deploy Web to Production
  deploy-web-production:
    needs: detect-changes
    if: needs.detect-changes.outputs.web-changed == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production-web
      url: https://ppop.link
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect-changes.outputs.release-tag }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.PROD_NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: web
        run: npm run build
      
      - name: Deploy to Vercel (Production)
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: apps/web
          scope: ${{ secrets.VERCEL_ORG_ID }}
      
      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: web
        with:
          environment: production
          version: ${{ needs.detect-changes.outputs.release-tag }}
          sourcemaps: apps/web/.next
      
      - name: Notify Slack
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Web Production Deployment ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Web Production Deployment*\nStatus: ${{ job.status }}\nRelease: ${{ needs.detect-changes.outputs.release-tag }}\nURL: https://ppop.link\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }

  # Post-deployment verification
  post-deployment-check:
    needs: [detect-changes, deploy-backend-production, deploy-web-production]
    if: always() && (needs.deploy-backend-production.result == 'success' || needs.deploy-web-production.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Verify deployments
        run: |
          echo "Deployment Summary:"
          echo "Release: ${{ needs.detect-changes.outputs.release-tag }}"
          echo "Backend: ${{ needs.deploy-backend-production.result }}"
          echo "Web: ${{ needs.deploy-web-production.result }}"
      
      - name: Final Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "Production Release Completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Release ${{ needs.detect-changes.outputs.release-tag }}*\n\nBackend: ${{ needs.deploy-backend-production.result }}\nWeb: ${{ needs.deploy-web-production.result }}\n\nRelease Notes: ${{ github.event.release.html_url }}"
                  }
                }
              ]
            }

